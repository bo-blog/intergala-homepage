<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Center-Cropped Image Thumbnails</title>
    <style>
        .thumbnail {
            margin: 10px;
        }
        #displays img {
            width: 120px;
        }
        #thumbnails {
            position: absolute;
            top: -1000%;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
    <input type="file" id="fileInput" multiple="multiple" accept="image/*">
    <button id="saveAllButton">保存全部</button>
    <div id="thumbnails"></div>
    <div id="displays"></div>
    <script>
    var imageFiles = {};

    document.getElementById('fileInput').addEventListener('change', handleFiles, false);
    document.getElementById('saveAllButton').addEventListener('click', saveAllThumbnails);

    function handleFiles(e) {
        var files = e.target.files;
        document.getElementById('thumbnails').innerHTML = '';
        document.getElementById('displays').innerHTML = '';
        imageFiles = {};

        for (var i = 0, f; f = files[i]; i++) {
            if (!f.type.startsWith('image/')){ continue }
            var reader = new FileReader();
            reader.onload = (function(theFile) {
                return function(e) {
                    imageFiles[e.target.result] = theFile.name;
                    var img = new Image();
                    img.onload = function() {
                        createThumbnail(img, e.target.result, theFile.name);
                    };
                    img.src = e.target.result;
                };
            })(f);
            reader.readAsDataURL(f);
        }
    }

    function createThumbnail(img, dataURL, fileName) {
        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext('2d');
        canvas.width = 400; // Thumbnail size
        canvas.height = 400;

        // Calculate the center cropping square
        var size = Math.min(img.width, img.height);
        var startX = (img.width - size) / 2;
        var startY = (img.height - size) / 2;

        // Draw the center cropped image onto the canvas
        ctx.drawImage(img, startX, startY, size, size, 0, 0, canvas.width, canvas.height);

        // Update the mapping for the filename
        imageFiles[canvas.toDataURL()] = fileName;

        var thumbnailsContainer = document.getElementById('thumbnails');
        var thumbImg = document.createElement('img');
        thumbImg.src = canvas.toDataURL();
        thumbImg.classList.add('thumbnail');
        thumbnailsContainer.appendChild(thumbImg);
        document.getElementById('displays').innerHTML = document.getElementById('thumbnails').innerHTML;
    }

    function saveAllThumbnails() {
        var zip = new JSZip();
        var imgs = document.getElementById('thumbnails').getElementsByTagName('img');
        for (var i = 0; i < imgs.length; i++) {
            let img = imgs[i];
            let dataURL = img.src;
            let fileName = imageFiles[dataURL];
            let base64Data = dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
            let imgData = atob(base64Data);
            let byteArray = new Uint8Array(imgData.length);

            for (let j = 0; j < imgData.length; j++) {
                byteArray[j] = imgData.charCodeAt(j);
            }

            zip.file(fileName, byteArray, {binary: true});
        }

        zip.generateAsync({type: 'blob'}).then(function(content) {
            saveAs(content, "thumbnails.zip");
        });
    }
    </script>
</body>
</html>
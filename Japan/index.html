<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" id="daylight" href="style.css">
    <title>Japan Photo Picks</title>
    <script src="definition.js"></script>
</head>
<body>
    <div id="progress"></div>
    <div id="headline">
        Photo Picks @Japan
    </div>
    <div id="category-tile">
    </div>
    <div id="nav-tile">
        <div id="pic-rolls">
        </div>
    </div>
    <div id="play-button"><span onclick="autoPlay()">► Play</span></div>
    <div id="footer">
        <a href="https://www.bobshen.com">&copy;Bob</a>
    </div>
    <div id="lightbox">
        <div id="picture-box">
            <div class="desc"><span id="description"></span></div>
        </div>
        <div id="left" class="buttons" onclick="goLeft()">❮</div>
        <div id="right" class="buttons" onclick="goRight()">❯</div>
        <div id="close" class="buttons" onclick="closePic()">✕</div>
        <div id="counter"><div id="counternum"></div></div>
    </div>
    <script>
        var cateGroup = ""
        var allCateIDs = []
        var preloader = {thumbnails: []}

        for (var i = 0; i < category.length; i++) {
            cateGroup += `
            <div id="cate-${category[i].id}" class="category-item" onclick="listCategory('${category[i].id}')"><span>${category[i].name}</span></div>
            `
            allCateIDs[i] = category[i].id
            preloader[category[i].id] = []
            for (var j = 0; j < photo[category[i].id].length; j++) {
                preloader.thumbnails[j] = new Image()
                preloader.thumbnails[j].src = `thumb/${photo[category[i].id][j].id}.jpg`
                console.log (`Preloaded thumbnail: thumb/${photo[category[i].id][j].id}.jpg`)
            }
        }
        document.querySelector("#category-tile").innerHTML = cateGroup
        var currentCate = allCateIDs[0]

        function switchHash() {
            var winHash = location.hash
            if (winHash.indexOf("#") != -1) {
                var currentCateTest = winHash.split("#")[1]
                if (allCateIDs.indexOf(currentCateTest) != -1) {
                    currentCate = currentCateTest
                }
            }
            document.querySelectorAll(".category-item").forEach((item) => item.classList.remove("cate-sel"))
            document.querySelector("#cate-"+currentCate).classList.add("cate-sel")
            setTimeout (() => {
                refreshThumbs(currentCate)
                document.querySelector("#pic-rolls").style.filter = "none"
                document.querySelector("#pic-rolls").style.opacity = 1
            }, 220)
            
        }
       switchHash()

       function listCategory(id) {
            location.hash = "#" + id
            document.querySelector("#pic-rolls").style.filter = "blur(3px)"
            document.querySelector("#pic-rolls").style.opacity = 0.5

            switchHash()
       }



        var lightbox = document.querySelector("#lightbox")
        var picture = document.querySelector("#picture-box")
        var description = document.querySelector("#description")
        var counter = document.querySelector("#counternum")
        var currentNum = 0


        function refreshThumbs(currentCate) {
            var descTitle = photo[currentCate]
            var totalImgs = descTitle.length
            var picGroup = ""
            for (var i = 0; i < totalImgs; i++) {
                picGroup += `
                <div class="thumbnail" style="background-image: url(thumb/${descTitle[i].id}.jpg);" onclick="showPic('${currentCate}', ${i})"></div>
                `
            }
            document.querySelector("#pic-rolls").innerHTML = picGroup
        }
        

        function showPic(cateID, num) {
            window.scrollTo({ top: 0, behavior: 'smooth' })
            currentNum = num
            lightbox.style.top = 0
            picture.style.filter = "grayscale(0)"
            picture.style.backgroundImage = `url("photo/${photo[cateID][num].id}.jpg")`
            description.innerHTML = photo[cateID][num].desc
            counter.textContent = `${num + 1} / ${photo[cateID].length}`

            var totalImgs = photo[cateID].length

            var lastCate = allCateIDs[allCateIDs.length - 1]
            
            if (num == totalImgs - 1) {
                if (cateID == lastCate) {
                    document.getElementById("right").style.display = "none"
                }
                else {
                    var nextCate = allCateIDs[allCateIDs.indexOf(cateID) + 1]
                    if (!preloader[nextCate][0]) {
                        preloader[nextCate][0] = new Image()
                        preloader[nextCate][0].src = `photo/${photo[nextCate][0].id}.jpg`
                        console.log (`Preloaded image: photo/${photo[nextCate][0].id}.jpg`)
                    }
                    document.getElementById("right").style.display = "block"
                }
            }
            else {
                if (!preloader[cateID][num + 1]) {
                    preloader[cateID][num + 1] = new Image()
                    preloader[cateID][num + 1].src = `photo/${photo[cateID][num + 1].id}.jpg`
                    console.log (`Preloaded image: photo/${photo[cateID][num + 1].id}.jpg`)
                }
                document.getElementById("right").style.display = "block"
            }
            if (num == 0) {
                if (cateID == allCateIDs[0]) {
                    document.getElementById("left").style.display = "none"
                }
                else {
                    var prevCate = allCateIDs[allCateIDs.indexOf(cateID) - 1]
                    var pID = photo[prevCate].length - 1
                    if (!preloader[prevCate][pID]) {
                        preloader[prevCate][pID] = new Image()
                        preloader[prevCate][pID].src = `photo/${photo[prevCate][pID].id}.jpg`
                        console.log (`Preloaded image: photo/${photo[prevCate][pID].id}.jpg`)
                    }
                    document.getElementById("left").style.display = "block"
                }
            }
            else {
                if (!preloader[cateID][num - 1]) {
                    preloader[cateID][num - 1] = new Image()
                    preloader[cateID][num - 1].src = `photo/${photo[cateID][num - 1].id}.jpg`
                    console.log (`Preloaded image: photo/${photo[cateID][num - 1].id}.jpg`)
                }
                document.getElementById("left").style.display = "block"
            }
            document.body.style.overflowY = "hidden"
        }

        function closePic() {
            lightbox.style.top = "-100vh"
            document.body.style.overflowY = "auto"
            clearInterval(autoplayer)
            document.getElementById("left").style.opacity = 0.4
            document.getElementById("right").style.opacity = 0.4
            document.getElementById("progress").style.display = "none"         
        }

        function goLeft() {
            if (currentNum > 0) {
                picture.style.filter = "grayscale(0.3)"
                currentNum--
                showPic(currentCate, currentNum)
            }
            else {
                if (currentCate != allCateIDs[0]) {
                    var prevCate = allCateIDs[allCateIDs.indexOf(currentCate) - 1]
                    listCategory(prevCate)
                    var pNum = photo[prevCate].length - 1
                    currentNum = pNum
                    showPic(prevCate, currentNum)
                }
            }
        }

        function goRight() {
            if (currentNum < photo[currentCate].length - 1) {
                picture.style.filter = "grayscale(0.3)"
                currentNum++
                showPic(currentCate, currentNum)
            }
            else {
                if (currentCate != allCateIDs[allCateIDs.length - 1]) {
                    var nextCate = allCateIDs[allCateIDs.indexOf(currentCate) + 1]
                    listCategory(nextCate)
                    currentNum = 0
                    showPic(nextCate, currentNum)
                }
            }
        }

        var autoplayer
        function autoPlay() {
            document.getElementById("left").style.opacity = 0
            document.getElementById("right").style.opacity = 0
            document.getElementById("progress").style.display = "block"
            showPic(currentCate, 0)
            autoplayer = setInterval(autoNext, 5000)
        }

        function autoNext() {
            document.getElementById("progress").style.animationPlayState = "initial"
            if (document.getElementById("right").style.display != "none") {
                document.getElementById("right").click()
            }
            else {
                document.getElementById("progress").style.animationPlayState = "paused"
                clearInterval(autoplayer)
                document.getElementById("progress").style.display = "none"       
            }
        }

    </script>
</body>
</html>